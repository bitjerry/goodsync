#include <stdlib.h>
#include "base.h"

const unsigned char TABLE_MAP[256] = {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x00, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39,
        0x3a, 0x3b, 0x3c, 0x3d, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
        0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e,
        0x0f, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x00, 0x00, 0x00,
        0x00, 0x3f, 0x00, 0x1a, 0x1b, 0x1c,
        0x1d, 0x1e, 0x1f, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x2a,
        0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30,
        0x31, 0x32, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00};

const unsigned char TABLE[] = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";


int base_encode(unsigned char *p_str, int len, unsigned char *out, int *out_len) {
    if (p_str == NULL) {
        return -1;
    }

    len <<= 3;
//    int res_len = (((len <<= 3) - 1) / GROUP + 1) * 4;
//    *out_len = res_len;

    int index = 0;
    unsigned char bytes = *p_str;
    int _out_len = 0;
    int j = BIT;
    do {
        for (int i = 0; i < 8; i++) {
            j--;
            if ((signed char) bytes < 0) index += (1 << j);
            if (j == 0) {
                *(out + (_out_len++)) = TABLE[index];
                j = BIT;
                index = 0;
            }
            bytes <<= 1;
        }
        bytes = *(++p_str);

    } while (len -= 8);
    if (j != BIT) {
        *(out + (_out_len++)) = TABLE[index];
    }
    *out_len = _out_len;
    return 0;
}

int base_decode(unsigned char *p_str, int len, unsigned char *out, int *out_len) {
    if (p_str == NULL) {
        return -1;
    }
    int _out_len = 0;
    unsigned char n = 0;
    unsigned char p = 0;
    unsigned char *p_out = out;
    unsigned char index = 0;
    for (int i = 0; i < len; i++) {
        index = *p_str;
        if (*(p_str++) == 0 || index == 0) {
            break;
        } else {
            p = TABLE_MAP[index];
        }
        if (n >= BIT) {
            n -= BIT;
            *(p_out - 1) += (p << n);
        } else {
            if (n > 0) {
                *(p_out - 1) += p >> (BIT - n);
            }
            *p_out = p << (DIFFER + n);
            _out_len++;
            p_out = out + _out_len;
            n += DIFFER;
        }
    }
    for (int i = _out_len - 1; !out[i--]; _out_len--);
    *out_len = _out_len;
    return 0;
}